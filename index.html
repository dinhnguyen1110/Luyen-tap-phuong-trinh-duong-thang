<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Tập Toán 10 - AI Powered</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .option-card { transition: all 0.15s ease; cursor: pointer; }
        .option-card:hover:not(.disabled) { transform: translateY(-1px); border-color: #3b82f6; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1); }
        .option-card.correct { background-color: #ecfdf5; border-color: #10b981; color: #065f46; box-shadow: 0 0 0 1px #10b981; }
        .option-card.wrong { background-color: #fef2f2; border-color: #ef4444; color: #991b1b; opacity: 0.8; }
        .disabled { pointer-events: none; }

        /* Animation for hint button */
        @keyframes pulse-attention {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        .hint-btn-attention { animation: pulse-attention 2s infinite; }

        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #9333ea; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Sparkle animation for AI button */
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        .ai-sparkle { animation: sparkle 1.5s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden">

    <!-- Header (Compact) -->
    <header class="bg-white shadow-sm z-20 flex-none">
        <div class="max-w-5xl mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-sm">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div>
                    <h1 class="font-bold text-base text-gray-800 leading-tight">Luyện Tập Toán AI</h1>
                    <p class="text-[10px] text-gray-500">GV: Nguyễn Đình Nguyên</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-right hidden sm:block">
                    <div class="text-xs font-semibold text-gray-500">Điểm</div>
                    <div class="text-lg font-bold text-blue-600 leading-none"><span id="score">0</span>/<span id="total-header">10</span></div>
                </div>
                <!-- Settings Button -->
                <button onclick="openSettings()" class="text-gray-400 hover:text-blue-600 transition-colors p-1.5" title="Cài đặt API Key">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="resetToOriginal()" class="text-gray-400 hover:text-blue-600 transition-colors p-1.5" title="Về đề gốc">
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
        </div>
        <div class="h-1 w-full bg-gray-100">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
        </div>
    </header>

    <!-- Main Content (Scrollable Area) -->
    <main class="flex-grow overflow-y-auto bg-gray-50">
        <div class="container mx-auto px-2 py-3 max-w-4xl h-full flex flex-col justify-center relative">
        
            <!-- API Key Modal -->
            <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-5 max-w-md w-full animate-bounce-in">
                    <h3 class="text-lg font-bold mb-2 flex items-center text-gray-800">
                        <i class="fa-brands fa-google text-blue-500 mr-2"></i> Cài đặt AI Key
                    </h3>
                    <p class="text-xs text-gray-500 mb-3">
                        Nhập Google Gemini API Key để kích hoạt tính năng tạo đề tự động.
                    </p>
                    <input type="password" id="api-key-input" placeholder="Dán API Key mới vào đây..." class="w-full p-2 border border-gray-300 rounded mb-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <div class="flex justify-end gap-2">
                        <button onclick="closeSettings()" class="px-3 py-1.5 text-gray-600 hover:bg-gray-100 rounded text-sm">Đóng</button>
                        <button onclick="saveApiKey()" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold">Lưu Key</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-blue-500">Lấy API Key miễn phí tại đây</a>
                    </p>
                </div>
            </div>

            <!-- Loading Screen (Overlay) -->
            <div id="loading-screen" class="hidden fixed inset-0 bg-white bg-opacity-95 z-40 flex flex-col items-center justify-center fade-in">
                <div class="loader mb-4"></div>
                <h3 class="text-xl font-bold text-purple-700 mb-1">AI đang soạn đề mới...</h3>
                <p class="text-gray-500 text-sm animate-pulse" id="loading-text">Đang đọc hiểu kiến thức...</p>
            </div>

            <!-- Welcome Screen -->
            <div id="welcome-screen" class="bg-white rounded-xl shadow-md p-6 text-center fade-in border-t-4 border-blue-500 max-w-lg mx-auto my-auto">
                <div class="mb-4 relative group">
                    <img 
                        src="https://img.freepik.com/free-vector/mathematics-concept-illustration_114360-3972.jpg?w=740" 
                        onerror="this.onerror=null; this.src='https://placehold.co/600x400/e2e8f0/1e293b?text=Math+Quiz';"
                        alt="Math Illustration" 
                        class="w-full max-w-xs mx-auto rounded-lg shadow-sm object-cover h-40"
                    >
                    <!-- AI Badge -->
                    <div class="absolute top-2 right-2 bg-purple-600 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI
                    </div>
                </div>
                <h2 class="text-2xl font-bold mb-1 text-gray-800">Phương Trình Đường Thẳng</h2>
                <p class="text-sm font-semibold text-blue-600 mb-4">GV: Nguyễn Đình Nguyên</p>
                <p class="text-gray-600 mb-6 text-sm">Hệ thống bài tập thông minh hỗ trợ bởi AI. Tạo đề mới không giới hạn.</p>
                <button onclick="startQuiz()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-8 rounded-full shadow-md transform transition hover:-translate-y-0.5 text-base">
                    Bắt đầu ngay <i class="fa-solid fa-play ml-1"></i>
                </button>
            </div>

            <!-- Quiz Container -->
            <div id="quiz-container" class="hidden h-full flex flex-col justify-center">
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 fade-in relative flex flex-col max-h-full">
                    
                    <!-- AI Tag if Generated -->
                    <div id="ai-indicator" class="hidden absolute top-0 right-0 bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded-bl-md border-l border-b border-purple-200 z-10">
                        <i class="fa-solid fa-robot mr-1"></i> AI Gen
                    </div>

                    <!-- Info Bar -->
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center rounded-t-xl flex-none">
                        <span class="font-bold text-gray-500 text-xs uppercase tracking-wider">Câu <span id="current-q-num">1</span>/<span id="total-q-num">10</span></span>
                        <span class="text-[10px] font-bold px-2 py-0.5 bg-blue-50 text-blue-700 rounded border border-blue-100">Trắc nghiệm</span>
                    </div>

                    <!-- Content (Scrollable inner) -->
                    <div class="p-4 md:p-6 overflow-y-auto flex-grow">
                        <!-- Question -->
                        <div id="question-text" class="text-lg font-bold text-gray-800 mb-3 leading-snug"></div>

                        <!-- Hint Area -->
                        <div class="mb-3 flex justify-end">
                            <button id="hint-btn" onclick="toggleHint()" class="text-amber-600 hover:text-amber-700 hover:bg-amber-50 border border-transparent hover:border-amber-200 font-semibold py-1 px-2 rounded text-xs transition-all flex items-center">
                                <i class="fa-regular fa-lightbulb mr-1.5"></i> Gợi ý
                            </button>
                        </div>

                        <div id="hint-box" class="hidden mb-4 bg-amber-50 border-l-2 border-amber-400 p-3 rounded-r text-sm">
                            <div class="flex items-start">
                                <div class="mr-2 mt-0.5"><i class="fa-solid fa-circle-info text-amber-500"></i></div>
                                <div>
                                    <span class="font-bold text-amber-800">Gợi ý:</span>
                                    <span id="hint-text" class="text-amber-900"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Options (2 Columns Grid) -->
                        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        
                        <!-- Rationale Box -->
                        <div id="rationale-box" class="hidden mt-4 bg-green-50 border border-green-200 rounded-lg p-3 animate-slide-up">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 bg-green-100 rounded-full p-1 mr-2"><i class="fa-solid fa-check text-green-600 text-sm"></i></div>
                                <div class="flex-grow text-sm">
                                    <h3 class="font-bold text-green-800 mb-1">Chính xác!</h3>
                                    <div id="rationale-text" class="text-gray-700 leading-relaxed"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Wrong Box -->
                        <div id="wrong-box" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-3 animate-slide-up">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 bg-red-100 rounded-full p-1 mr-2"><i class="fa-solid fa-xmark text-red-600 text-sm"></i></div>
                                <div class="flex-grow text-sm">
                                    <h3 class="font-bold text-red-800 mb-1">Chưa chính xác</h3>
                                    <p class="text-red-700 mb-1">Đáp án đúng: <span id="correct-answer-label" class="font-bold"></span></p>
                                    <div id="wrong-rationale-text" class="text-gray-700 leading-relaxed border-t border-red-100 pt-1 mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation (Fixed bottom of card) -->
                    <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center rounded-b-xl flex-none">
                         <button id="prev-btn" onclick="prevQuestion()" class="hidden text-gray-500 hover:text-gray-700 font-semibold py-1.5 px-3 rounded hover:bg-gray-200 text-sm">
                            <i class="fa-solid fa-arrow-left mr-1"></i> Trước
                        </button>
                        
                        <button id="next-btn" onclick="nextQuestion()" class="hidden bg-gray-800 hover:bg-gray-900 text-white font-bold py-1.5 px-5 rounded-lg shadow transition-all text-sm transform hover:scale-105 ml-auto">
                            Tiếp theo <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                    </div>

                </div>
            </div>

            <!-- Completion Screen -->
            <div id="completion-screen" class="hidden text-center bg-white rounded-xl shadow-lg p-6 fade-in border-t-4 border-yellow-400 max-w-lg mx-auto my-auto">
                <div class="mb-4 inline-block p-4 rounded-full bg-yellow-50 shadow-inner">
                    <i class="fa-solid fa-trophy text-4xl text-yellow-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Kết quả</h2>
                <p class="text-gray-600 mb-4 text-lg">Đúng <span id="final-score" class="font-bold text-blue-600"></span>/<span id="total-questions-final"></span> câu.</p>
                
                <!-- Analysis Section -->
                <div id="feedback-container" class="mb-6 text-left bg-gray-50 rounded-lg p-4 border border-gray-100 text-sm"></div>

                <div class="flex flex-col sm:flex-row justify-center gap-3">
                    <button onclick="resetToOriginal()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition text-sm">
                        <i class="fa-solid fa-rotate-left mr-1.5"></i> Đề gốc
                    </button>
                    
                    <!-- AI Button -->
                    <button onclick="generateAIQuiz()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg shadow transition transform hover:-translate-y-0.5 flex items-center justify-center group text-sm">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1.5 ai-sparkle"></i> 
                        <span>Luyện tập thêm (AI)</span>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-2 bg-white border-t border-gray-100 text-gray-400 text-[10px] flex-none">
        <p>Hỗ trợ bởi Google Gemini</p>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // ============================================================
        // CẤU HÌNH API KEY (QUAN TRỌNG)
        // ============================================================
        // Để tránh bị Google hủy khóa khi tải lên GitHub, hãy làm theo cách sau:
        // 1. Vào https://aistudio.google.com/app/apikey tạo Key MỚI.
        // 2. Chia khóa thành 2 phần và điền vào dưới đây (để đánh lừa bộ quét):
        
        // Ví dụ Key của bạn là: AIzaSyD...XYZ
        // Thì điền: 
        // const PART_1 = "AIzaSyD..."; 
        // const PART_2 = "XYZ";
        
        const PART_1 = "AIzaSyBKG_pbB0Z0w0ie"; // Điền 1 nửa đầu Key vào đây (nếu muốn hardcode)
        const PART_2 = "8PMHdJJSEvUv99_t8ww"; // Điền 1 nửa sau Key vào đây
        // ============================================================

        // Original Data (Source of Truth)
        const originalData = [
            {
                id: 1,
                topic: "Vectơ chỉ phương",
                question: "Một vectơ chỉ phương của đường thẳng $\\begin{cases}x=2+3t\\\\ y=-3-t\\end{cases}$ là:",
                options: [
                    { text: "$\\vec{u}=(2;-3)$", correct: false },
                    { text: "$\\vec{u}=(3;-1)$", correct: true },
                    { text: "$\\vec{u}=(3;1)$", correct: false },
                    { text: "$\\vec{u}=(3;-3)$", correct: false }
                ],
                hint: "Với phương trình tham số $\\begin{cases}x=x_0+at\\\\ y=y_0+bt\\end{cases}$, vectơ chỉ phương là $\\vec{u}=(a;b)$.",
                rationale: "Phương trình đường thẳng có dạng $\\begin{cases}x=x_0+at\\\\ y=y_0+bt\\end{cases}$ với $a=3, b=-1$.<br>Do đó, vectơ chỉ phương là $\\vec{u}=(3; -1)$."
            },
            {
                id: 3,
                topic: "Phương trình tham số",
                question: "Trong mặt phẳng tọa độ $Oxy$, đường thẳng $d$ đi qua điểm $A(1;-2)$ và có vectơ chỉ phương $\\vec{u}=(3;5)$ có phương trình tham số là:",
                options: [
                    { text: "$\\begin{cases}x=3+2t\\\\ y=5+t\\end{cases}$", correct: false },
                    { text: "$\\begin{cases}x=3+t\\\\ y=5-2t\\end{cases}$", correct: false },
                    { text: "$\\begin{cases}x=1+3t\\\\ y=-2+5t\\end{cases}$", correct: true },
                    { text: "$\\begin{cases}x=1+5t\\\\ y=-2-3t\\end{cases}$", correct: false }
                ],
                hint: "Phương trình tham số đi qua $M(x_0; y_0)$ với vtcp $\\vec{u}=(a;b)$ là $\\begin{cases}x=x_0+at\\\\ y=y_0+bt\\end{cases}$.",
                rationale: "Thay tọa độ điểm đi qua $(1; -2)$ và vectơ chỉ phương $(3; 5)$ vào công thức tổng quát, ta được:<br>$\\begin{cases}x=1+3t\\\\ y=-2+5t\\end{cases}$."
            },
            {
                id: 4,
                topic: "Vectơ pháp tuyến",
                question: "Một vectơ pháp tuyến của đường thẳng $2x-3y+6=0$ là:",
                options: [
                    { text: "$\\vec{n}=(2;-3)$", correct: true },
                    { text: "$\\vec{n}=(2;3)$", correct: false },
                    { text: "$\\vec{n}=(3;2)$", correct: false },
                    { text: "$\\vec{n}=(-3;2)$", correct: false }
                ],
                hint: "Đường thẳng có phương trình tổng quát $Ax + By + C = 0$ có vectơ pháp tuyến là $\\vec{n}=(A; B)$.",
                rationale: "Từ phương trình $2x - 3y + 6 = 0$, ta có hệ số của $x$ là $2$ và hệ số của $y$ là $-3$.<br>Vậy vectơ pháp tuyến là $\\vec{n}=(2; -3)$."
            },
            {
                id: 5,
                topic: "Chuyển đổi VTPT sang VTCP",
                question: "Cho đường thẳng $\\Delta$ có phương trình tổng quát $-2x+3y-1=0$. Vectơ nào sau đây là vectơ chỉ phương của đường thẳng $\\Delta$?",
                options: [
                    { text: "$(3;2)$", correct: true },
                    { text: "$(2;3)$", correct: false },
                    { text: "$(-3;2)$", correct: false },
                    { text: "$(2;-3)$", correct: false }
                ],
                hint: "Nếu đường thẳng có vtpt $\\vec{n}=(A; B)$ thì vtcp là $\\vec{u}=(-B; A)$ hoặc $\\vec{u}=(B; -A)$.",
                rationale: "Đường thẳng có vtpt $\\vec{n}=(-2; 3)$.<br>Suy ra vtcp $\\vec{u}=(3; 2)$ (vì tích vô hướng $\\vec{n}.\\vec{u} = -2.3 + 3.2 = 0$)."
            },
            {
                id: 6,
                topic: "Điểm thuộc đường thẳng",
                question: "Cho đường thẳng $d: 3x+5y-15=0$. Trong các điểm sau đây, điểm nào **không** thuộc đường thẳng $d$?",
                options: [
                    { text: "$M_1(5;0)$", correct: false },
                    { text: "$M_4(-5;6)$", correct: false },
                    { text: "$M_2(0;3)$", correct: false },
                    { text: "$M_3(5;3)$", correct: true }
                ],
                hint: "Thay tọa độ $(x; y)$ của điểm vào phương trình. Nếu kết quả $\\neq 0$ thì điểm đó không thuộc đường thẳng.",
                rationale: "Thay tọa độ $M_3(5;3)$ vào vế trái phương trình:<br>$3(5) + 5(3) - 15 = 15 + 15 - 15 = 15 \\neq 0$.<br>Vậy $M_3$ không thuộc $d$."
            },
            {
                id: 7,
                topic: "Khoảng cách",
                question: "Khoảng cách từ điểm $M(4;-2)$ đến đường thẳng $\\Delta: x-2y+2=0$ bằng:",
                options: [
                    { text: "$\\frac{2\\sqrt{5}}{5}$", correct: false },
                    { text: "$2\\sqrt{5}$", correct: true },
                    { text: "$2$", correct: false },
                    { text: "$\\sqrt{5}$", correct: false }
                ],
                hint: "Công thức khoảng cách: $d(M, \\Delta) = \\frac{|Ax_0 + By_0 + C|}{\\sqrt{A^2 + B^2}}$.",
                rationale: "Áp dụng công thức khoảng cách:<br>$$d = \\frac{|1(4) - 2(-2) + 2|}{\\sqrt{1^2 + (-2)^2}} = \\frac{|4 + 4 + 2|}{\\sqrt{5}} = \\frac{10}{\\sqrt{5}} = 2\\sqrt{5}$$"
            },
            {
                id: 8,
                topic: "Góc giữa 2 đường thẳng",
                question: "Cho $\\Delta_1: x-2y+3=0$ và $\\Delta_2: -2x-y+5=0$. Số đo góc giữa hai đường thẳng này là:",
                options: [
                    { text: "$30^\\circ$", correct: false },
                    { text: "$45^\\circ$", correct: false },
                    { text: "$90^\\circ$", correct: true },
                    { text: "$60^\\circ$", correct: false }
                ],
                hint: "Tính tích vô hướng hai vectơ pháp tuyến $\\vec{n_1}$ và $\\vec{n_2}$. Nếu bằng 0 thì hai đường thẳng vuông góc.",
                rationale: "Ta có $\\vec{n_1}=(1; -2)$ và $\\vec{n_2}=(-2; -1)$.<br>Tích vô hướng: $\\vec{n_1}.\\vec{n_2} = 1.(-2) + (-2).(-1) = -2 + 2 = 0$.<br>Vì tích vô hướng bằng 0 nên hai vectơ vuông góc, suy ra góc giữa hai đường thẳng là $90^\\circ$."
            },
            {
                id: 9,
                topic: "PT tham số đi qua 2 điểm",
                question: "Trong mặt phẳng tọa độ $Oxy$, phương trình tham số của đường thẳng đi qua $M(1;-2)$ và $N(4;3)$ là:",
                options: [
                    { text: "$\\begin{cases}x=1+3t\\\\ y=-2+5t\\end{cases}$", correct: true },
                    { text: "$\\begin{cases}x=1+5t\\\\ y=-2-3t\\end{cases}$", correct: false },
                    { text: "$\\begin{cases}x=3+3t\\\\ y=4+5t\\end{cases}$", correct: false },
                    { text: "$\\begin{cases}x=4+t\\\\ y=3-2t\\end{cases}$", correct: false }
                ],
                hint: "Vectơ chỉ phương chính là vectơ $\\vec{MN} = (x_N - x_M; y_N - y_M)$.",
                rationale: "Vectơ chỉ phương $\\vec{u} = \\vec{MN} = (4-1; 3-(-2)) = (3; 5)$.<br>Đường thẳng đi qua $M(1; -2)$ với vtcp $(3; 5)$ có pt: $\\begin{cases}x=1+3t\\\\ y=-2+5t\\end{cases}$."
            },
            {
                id: 10,
                topic: "PT song song",
                question: "Trong mặt phẳng $Oxy$, đường thẳng $\\Delta$ đi qua điểm $M(-2;0)$ và song song với đường thẳng $d: 2x-y+2=0$ có phương trình là:",
                options: [
                    { text: "$2x-y=0$", correct: false },
                    { text: "$2x-y+4=0$", correct: true },
                    { text: "$2x+y+4=0$", correct: false },
                    { text: "$x+2y+2=0$", correct: false }
                ],
                hint: "Hai đường thẳng song song thì có cùng vectơ pháp tuyến. Phương trình sẽ có dạng $2x - y + C = 0$ ($C \\neq 2$).",
                rationale: "Vì $\\Delta // d$ nên $\\Delta$ có dạng $2x - y + c = 0$.<br>Vì $M(-2; 0) \\in \\Delta$, thay tọa độ vào: $2(-2) - 0 + c = 0 \\Rightarrow -4 + c = 0 \\Rightarrow c = 4$.<br>Vậy pt là $2x - y + 4 = 0$."
            },
            {
                id: 11,
                topic: "PT tổng quát từ điểm và VTPT",
                question: "Đường thẳng đi qua điểm $M(2;-3)$ và nhận $\\vec{n}=(3;1)$ làm vectơ pháp tuyến có phương trình tổng quát là:",
                options: [
                    { text: "$3x+y-9=0$", correct: false },
                    { text: "$x-3y-11=0$", correct: false },
                    { text: "$3x+y-3=0$", correct: true },
                    { text: "$3x-y-9=0$", correct: false }
                ],
                hint: "Áp dụng công thức: $A(x - x_0) + B(y - y_0) = 0$.",
                rationale: "Phương trình: $3(x - 2) + 1(y - (-3)) = 0$<br>$\\Leftrightarrow 3x - 6 + y + 3 = 0$<br>$\\Leftrightarrow 3x + y - 3 = 0$."
            },
            {
                id: 12,
                topic: "PT tổng quát đi qua 2 điểm",
                question: "Trong mặt phẳng $Oxy$, cho hai điểm $A(-2;4)$ và $B(-6;1)$. Phương trình đường thẳng đi qua hai điểm A và B là:",
                options: [
                    { text: "$3x-4y-22=0$", correct: false },
                    { text: "$3x-4y+8=0$", correct: false },
                    { text: "$3x-4y+22=0$", correct: true },
                    { text: "$3x+4y-10=0$", correct: false }
                ],
                hint: "Tìm vectơ $\\vec{AB}$, suy ra vectơ pháp tuyến $\\vec{n}$, sau đó viết phương trình tổng quát.",
                rationale: "Ta có $\\vec{AB} = (-4; -3)$.<br>Suy ra vectơ pháp tuyến $\\vec{n} = (3; -4)$ (đảo vị trí và đổi dấu 1 thành phần).<br>Phương trình qua $A(-2; 4)$: $3(x - (-2)) - 4(y - 4) = 0$<br>$\\Leftrightarrow 3x + 6 - 4y + 16 = 0$<br>$\\Leftrightarrow 3x - 4y + 22 = 0$."
            }
        ];

        let quizData = JSON.parse(JSON.stringify(originalData));
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;
        let userAnswers = new Array(quizData.length).fill(null);
        let audioCtx = null;
        let isAiMode = false;

        const welcomeScreen = document.getElementById('welcome-screen');
        const quizContainer = document.getElementById('quiz-container');
        const completionScreen = document.getElementById('completion-screen');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const currentQNum = document.getElementById('current-q-num');
        const totalQNum = document.getElementById('total-q-num');
        const scoreDisplay = document.getElementById('score');
        const totalHeader = document.getElementById('total-header');
        const progressBar = document.getElementById('progress-bar');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const hintBtn = document.getElementById('hint-btn');
        const hintBox = document.getElementById('hint-box');
        const rationaleBox = document.getElementById('rationale-box');
        const wrongBox = document.getElementById('wrong-box');
        const feedbackContainer = document.getElementById('feedback-container');
        const aiIndicator = document.getElementById('ai-indicator');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');

        // --- Settings Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) apiKeyInput.value = savedKey;
        });

        function openSettings() {
            settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                alert('Đã lưu API Key! Bạn có thể bắt đầu dùng tính năng AI.');
                closeSettings();
            } else {
                alert('Vui lòng nhập API Key.');
            }
        }

        function getEffectiveApiKey() {
            // Priority 1: Key from LocalStorage (User entered)
            const localKey = localStorage.getItem('gemini_api_key');
            if(localKey) return localKey;

            // Priority 2: Hardcoded Key (If teacher filled it)
            if(PART_1 && PART_2) return PART_1 + PART_2;

            return null;
        }

        // --- Sound Logic ---
        function initAudio() {
            if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            initAudio();
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            
            if (type === 'correct') {
                const freqs = [523.25, 659.25, 783.99, 1046.50];
                freqs.forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine'; osc.frequency.value = f;
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.1, now + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8 + (i * 0.1));
                    osc.start(now); osc.stop(now + 1.5);
                });
            } else {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(200, now);
                oscillator.frequency.exponentialRampToValueAtTime(50, now + 0.4);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.2, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                oscillator.start(now); oscillator.stop(now + 0.5);
            }
        }

        function startQuiz() {
            initAudio();
            welcomeScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            completionScreen.classList.add('hidden');
            
            if(isAiMode) aiIndicator.classList.remove('hidden');
            else aiIndicator.classList.add('hidden');

            totalQNum.textContent = quizData.length;
            totalHeader.textContent = quizData.length;
            
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = new Array(quizData.length).fill(null);
            scoreDisplay.textContent = '0';
            
            loadQuestion();
        }

        function loadQuestion() {
            const data = quizData[currentQuestionIndex];
            const savedIndex = userAnswers[currentQuestionIndex];
            answered = savedIndex !== null;

            currentQNum.textContent = currentQuestionIndex + 1;
            progressBar.style.width = `${(currentQuestionIndex / quizData.length) * 100}%`;
            
            hintBox.classList.add('hidden');
            rationaleBox.classList.add('hidden');
            wrongBox.classList.add('hidden');
            
            prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);

            if (answered) {
                nextBtn.classList.remove('hidden');
                hintBtn.disabled = true; hintBtn.classList.add('opacity-50', 'cursor-not-allowed');
                const isCorrect = data.options[savedIndex].correct;
                if (isCorrect) {
                    document.getElementById('rationale-text').innerHTML = data.rationale;
                    rationaleBox.classList.remove('hidden');
                } else {
                    document.getElementById('correct-answer-label').innerHTML = data.options.find(o => o.correct).text;
                    document.getElementById('wrong-rationale-text').innerHTML = data.rationale;
                    wrongBox.classList.remove('hidden');
                }
            } else {
                nextBtn.classList.add('hidden');
                hintBtn.disabled = false; hintBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            questionText.innerHTML = data.question;
            document.getElementById('hint-text').innerHTML = data.hint;
            
            optionsContainer.innerHTML = '';
            data.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                let cls = 'option-card bg-white border-2 border-gray-100 rounded-lg p-3 flex items-center shadow-sm hover:shadow-md transition-all';
                let icon = '';
                
                if (answered) {
                    cls += ' disabled';
                    if (opt.correct) {
                        cls += ' correct';
                        icon = '<i class="fa-solid fa-circle-check fa-lg text-green-600 ml-auto"></i>';
                    } else if (idx === savedIndex) {
                        cls += ' wrong';
                        icon = '<i class="fa-solid fa-circle-xmark fa-lg text-red-600 ml-auto"></i>';
                    }
                }

                btn.className = cls;
                btn.onclick = () => selectAndCheck(idx);
                btn.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center mr-3 border border-gray-200 text-sm flex-shrink-0">${String.fromCharCode(65+idx)}</div>
                    <div class="text-gray-700 font-bold text-base flex-grow">${opt.text}</div>
                    ${icon}
                `;
                optionsContainer.appendChild(btn);
            });

            if(window.MathJax) MathJax.typesetPromise();
        }

        function selectAndCheck(index) {
            if (answered) return;
            answered = true;
            userAnswers[currentQuestionIndex] = index;
            
            const isCorrect = quizData[currentQuestionIndex].options[index].correct;
            if (isCorrect) {
                score++;
                playSound('correct');
            } else {
                playSound('wrong');
            }
            scoreDisplay.textContent = score;
            loadQuestion();
        }

        function toggleHint() {
            document.getElementById('hint-box').classList.toggle('hidden');
            if(window.MathJax) MathJax.typesetPromise([hintBox]);
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                showCompletion();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function showCompletion() {
            quizContainer.classList.add('hidden');
            completionScreen.classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-questions-final').textContent = quizData.length;
            progressBar.style.width = '100%';

            // Generate Feedback
            let weakTopics = new Set();
            quizData.forEach((q, idx) => {
                const ansIdx = userAnswers[idx];
                if (ansIdx === null || !q.options[ansIdx].correct) weakTopics.add(q.topic);
            });

            let html = '';
            if (score >= 9) html += `<div class="text-green-700 mb-4 font-bold text-base"><i class="fa-solid fa-star mr-2"></i>Xuất sắc!</div>`;
            else if (score >= 7) html += `<div class="text-blue-700 mb-4 font-bold text-base"><i class="fa-solid fa-thumbs-up mr-2"></i>Khá tốt!</div>`;
            else html += `<div class="text-red-600 mb-4 font-bold text-base"><i class="fa-solid fa-book-open mr-2"></i>Cần cố gắng hơn!</div>`;

            if (weakTopics.size > 0) {
                html += `<div class="mt-4 pt-4 border-t border-gray-200"><p class="font-bold mb-2">Cần ôn tập:</p><ul class="space-y-2">`;
                weakTopics.forEach(t => html += `<li class="bg-gray-50 p-2 rounded text-xs"><i class="fa-solid fa-arrow-right text-red-400 mr-2"></i>${t}</li>`);
                html += `</ul></div>`;
            } else {
                html += `<div class="mt-4 pt-4 border-t text-sm text-gray-600">Bạn đã làm đúng tất cả!</div>`;
            }
            feedbackContainer.innerHTML = html;
        }

        function resetToOriginal() {
            quizData = JSON.parse(JSON.stringify(originalData));
            isAiMode = false;
            completionScreen.classList.add('hidden');
            startQuiz();
        }

        // --- AI GENERATION LOGIC ---
        async function generateAIQuiz() {
            const key = getEffectiveApiKey();
            if(!key) {
                alert("Vui lòng nhập API Key trong phần Cài đặt (nút Bánh răng) để sử dụng tính năng này.");
                openSettings();
                return;
            }

            loadingScreen.classList.remove('hidden');
            
            // Animation Text
            const msgs = ["Đang đọc hiểu kiến thức...", "Đang thay đổi số liệu...", "Đang tính toán đáp án...", "Đang kiểm tra LaTeX..."];
            let i = 0;
            const interval = setInterval(() => { loadingText.innerText = msgs[i++ % msgs.length]; }, 1500);

            try {
                // Construct Prompt
                const prompt = `
                    Act as a Math Teacher in Vietnam.
                    I have a JSON list of ${originalData.length} math questions (Grade 10 - Line Equations).
                    
                    TASK: Generate a NEW set of ${originalData.length} questions based on the list below.
                    
                    STRICT RULES:
                    1. For EACH question in the source, create a clone that tests the SAME concept/topic.
                    2. CHANGE THE NUMBERS/COORDINATES/EQUATIONS. Do NOT reuse the exact same numbers.
                    3. Calculate the correct answer accurately for the new numbers.
                    4. Keep the output format exactly valid JSON.
                    5. Output JSON structure: [{"id": 1, "topic": "...", "question": "LaTeX string", "options": [{"text": "LaTeX", "correct": boolean}...], "hint": "...", "rationale": "..."}]
                    6. Use LaTeX ($...$) for all math expressions.
                    7. Language: Vietnamese.
                    8. Do NOT return markdown blocks (no \`\`\`json). Just the raw JSON array.

                    Source Questions:
                    ${JSON.stringify(originalData)}
                `;

                // Call Google Gemini API
                // Using gemini-2.5-flash which is stable
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const result = await response.json();
                
                if (result.error) throw new Error(result.error.message);

                let rawText = result.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

                const newQuestions = JSON.parse(rawText);

                if (Array.isArray(newQuestions) && newQuestions.length > 0) {
                    quizData = newQuestions;
                    isAiMode = true; 
                    
                    clearInterval(interval);
                    loadingScreen.classList.add('hidden');
                    
                    startQuiz();
                } else {
                    throw new Error("Dữ liệu trả về không đúng định dạng.");
                }

            } catch (e) {
                clearInterval(interval);
                loadingScreen.classList.add('hidden');
                console.error(e);
                alert("Lỗi khi tạo đề: " + e.message + "\n\nVui lòng thử lại sau.");
            }
        }
    </script>
</body>
</html>
